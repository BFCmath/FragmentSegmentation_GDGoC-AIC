# ENEOPI Fragment Segmentation Server

This server provides an API and a web interface for segmenting objects in images and estimating their volumes. It utilizes YOLO-based models and can incorporate depth information for enhanced accuracy.

## Features

- **Dual Segmentation Modes:**  - **Fast (RGB):** Uses a YOLO ONNX model optimized for speed, processing standard RGB images with 2D-based volume estimation.  - **Precise (RGB-D):** Employs a YOLO ONNX model that leverages depth information (generated by the Depth Anything V2 model) alongside RGB data for more accurate segmentation with point cloud-based volume calculation.
- **API Endpoints:**
  - `GET /`: Serves the HTML homepage. (Authentication Required)
  - `POST /predict`: Accepts image uploads for segmentation. (Authentication Required)
    - Input: Image file (JPEG/PNG), `use_depth` query parameter ("fast" or "precise").
    - Output: JSON with segmentation mask (Base64 PNG), calculated volumes, and processing time.
- **User Authentication:** Secure access to the segmentation service and homepage via JWT-based authentication (login, registration).
- **Web Frontend:** A user-friendly interface for:
  - User registration and login.
  - Image uploading and selection of segmentation mode.
  - Displaying the segmented image and volume results.
- **ONNX Model Inference:** Utilizes ONNX runtime for efficient model execution.
- **Depth Estimation:** Integrates the Depth Anything V2 model for generating depth maps from RGB images.
- **Configuration:** Centralized settings management via `config.py` and environment variables.
- **Docker Support:** Includes `Dockerfile` and `docker-compose.yml` for easy deployment and dependency management.
- **Logging:** Comprehensive logging of server events and errors to `api.log` and console.

## Server Folder Structure and File Explanations

Here's an overview of the key files and directories within the `server` folder:

- `app.py`: The main FastAPI application file. It defines API endpoints, handles request processing, authentication, integrates model handlers, and manages the application lifecycle (e.g., loading models on startup).
- `model.py`: Contains the core logic for image analysis.
  - `BaseModelHandler`: Abstract base class for model handling.
  - `ModelHandler`: Manages the standard RGB YOLO segmentation model (preprocessing, ONNX inference, postprocessing to generate masks and volumes).
  - `RGBDModelHandler`: Manages the RGB-D YOLO segmentation model, integrating depth information from the `DepthHandler`.
- `config.py`: Stores all configuration settings for the server, models, and environment. This includes model paths, image dimensions, logging preferences, CORS settings, and API behavior parameters.
- `requirements.txt`: Lists all Python dependencies required to run the server.
- `.env_example`: An example file showing the environment variables that can be used to configure the server (e.g., `PORT`, `DEV_MODE`, `LOG_LEVEL`). Create a `.env` file based on this example for your local setup.

- `weights/`: **Crucial directory.** This is where the pre-trained model weights (`.onnx` for YOLO models, `.pth` for Depth Anything) must be placed.
  - `yolo_rgb_nano.onnx`: YOLO model for RGB-based segmentation.
  - `yolo_rgbd_nano.onnx`: YOLO model for RGB-D (depth-enhanced) segmentation.
  - `depth_anything_v2_vits.pth`: Depth Anything V2 model weights (ViT-Small variant).

- `utils/`: Contains utility modules.  - `depth_handler.py`: Manages the Depth Anything V2 model, including loading the model, preprocessing images for depth estimation, running inference, and postprocessing the depth map.  - `pointcloud.py`: Provides point cloud generation and volume calculation utilities. Used by the RGBD model to compute 3D volumes from RGB and depth data using convex hull algorithms.  - `depth_anything_v2/`: Contains the source code and any associated files for the Depth Anything V2 model.

- `auth/`: Contains modules related to user authentication and authorization.
  - `routes.py`: Defines the API routes for authentication functionalities like login (`/auth/token`), user registration (`/auth/users/`), and fetching current user details (`/auth/users/me`).
  - `models.py`: Defines the SQLAlchemy database model for users (e.g., `User` table with username, email, hashed password).
  - `schemas.py`: Contains Pydantic schemas used for data validation and serialization in authentication requests and responses (e.g., `UserCreate`, `Token`).
  - `auth_handler.py`: Provides helper functions for authentication logic, such as password hashing and verification, and JWT token creation and decoding.
  - `database.py`: Defines the database engine, session management, and functions to create database tables (e.g., for users).
  - `dependencies.py`: Includes FastAPI dependency functions, such as `get_current_user` and `get_optional_current_user` for authenticating API requests.

- `frontend/`: Contains all static files for the web-based user interface.
  - `html/`: HTML files for the main application page (`index.html`), login (`login.html`), and registration (`signup.html`).
  - `js/`: JavaScript files (`main.js`, `auth.js`) that handle client-side logic, API interactions, and dynamic content updates for the frontend.
  - `css/`: CSS files (`styles.css`, `auth.css`) for styling the frontend.

- `docker/`: Contains files for building and running the server with Docker.
  - `Dockerfile`: Defines the instructions to build a Docker image for the server, encapsulating all dependencies and code.
  - `docker-compose.yml`: A Docker Compose file for easily building and running the server container with predefined configurations, including volume mapping for weights and port forwarding.
  - `.dockerignore`: Specifies files and directories to ignore when building the Docker image to optimize build times and image size.

## Setup

### 1. Environment Variables
Create a `.env` file in the `server` directory by copying `.env_example`. You can customize variables like `PORT` or `LOG_LEVEL` if needed.

```bash
cp .env_example .env
```

### 2. Model Weights

The server requires pre-trained model weights to function.

**Download the weights:**

Please download the necessary model files from the following link:
[EnEoPi Weights](https://drive.google.com/drive/folders/1REDe3jkkYV856jkzJiQ5LFVdSxQ5qXeQ?usp=sharing)

**Place the weights:**

1. Ensure the `server/weights` directory exists. If not, create it:

    ```bash
    mkdir -p server/weights
    ```

2. Place the downloaded files directly into the `server/weights/` directory. The required files are:
    - `yolo_rgb_nano.onnx`
    - `yolo_rgbd_nano.onnx`
    - `depth_anything_v2_vits.pth`

### 3. Python Environment (for running without Docker)

If you choose not to use Docker, you'll need Python 3.9 or newer. It's highly recommended to use a virtual environment.

Create and activate a virtual environment:

```bash
python -m venv venv
# On Windows
venv\Scripts\activate
# On macOS/Linux
source venv/bin/activate
```

Then, install the dependencies:

```bash
pip install -r requirements.txt
```

## Running the Server

There are two main ways to run the server:

### Method 1: Using Docker (Recommended)

This is the easiest and recommended way to run the server as it handles all dependencies and environment setup automatically.

1. **Prerequisites:**
    - Docker and Docker Compose installed.
    - Model weights placed in `server/weights/` as described above. The `docker-compose.yml` in the `docker/` subdirectory is configured to mount `../weights:/app/weights` (relative to the `docker-compose.yml` file's location). Ensure your weights are in `server/weights/`.
    - A `.env` file created in the `server/` directory (see "Environment Variables" section).

2. **Build and Start:**
    Navigate to the `server/docker` directory (where the `docker-compose.yml` file is located) and run:

    ```bash
    docker-compose up -d --build
    ```

    The `--build` flag ensures the image is rebuilt if there are changes. `-d` runs it in detached mode.

3. **Access the Server:**
   The application (including UI and API) will be available at [http://localhost:3000](http://localhost:3000) (or the `PORT` you specified in your `.env` file). First-time users will be redirected to the login/registration page.

### Method 2: Running Directly with Python (Without Docker)

1. **Prerequisites:**
    - Python 3.9+ installed and virtual environment activated.
    - All dependencies installed from `requirements.txt`.
    - Model weights placed in `server/weights/`.
    - A `.env` file created in the `server/` directory.

2. **Start the Server:**
    Navigate to the `server` directory and run:

    ```bash
    python app.py
    ```

    This will run the server using the Uvicorn settings defined in `app.py` (typically development mode with reload).

    For production-like execution without Docker, matching the Docker CMD (and respecting `.env` variables):

    ```bash
    uvicorn app:app --host 0.0.0.0 --port 3000
    ```

    (Adjust host and port if they differ in your `.env` or `config.py`)

## Accessing the Server

Once the server is running (either via Docker or directly), you can access its UI and API.

- **Web UI & API Base URL:** `http://localhost:3000` (or the port configured in your `.env` file).
- **Important:** When accessing through a browser, always use `localhost` or `127.0.0.1` instead of `0.0.0.0`.

Users will typically be directed to `/frontend/html/login.html` if not authenticated. After logging in or registering, they can access the main application page (`/`) served from `frontend/html/index.html`.

## API Endpoints

- `GET /`: Serves the HTML homepage. Requires authentication.
- `POST /auth/token`: User login. Expects `application/x-www-form-urlencoded` with `username` and `password`. Returns JWT access token.
- `POST /auth/users/`: User registration. Expects JSON with `username`, `email`, `password`, `confirm_password`.
- `GET /auth/users/me`: Get details for the currently authenticated user. Requires authentication.
- `POST /predict`: Endpoint for submitting images for segmentation. Requires authentication.
  - **Request Body**: `multipart/form-data`
    - `file`: The image file (JPEG/PNG).
    - `use_depth` (query parameter, optional):
      - `"fast"` (default): Uses the RGB model.
      - `"precise"`: Uses the RGBD model for depth-enhanced segmentation.
  - **Response**: A JSON object containing:
    - `success` (boolean): True if processing was successful.
    - `image_data` (string, optional): Base64 encoded string of the processed image with segmentation masks.
    - `volumes` (list, optional): A list of calculated volumes for each detected segment.
    - `process_time_ms` (number, optional): Time taken for processing in milliseconds.
    - `error` (string, optional): Error message if processing failed.

## Environment Variables

The server can be configured using environment variables (especially relevant for Docker deployments):

- `PORT`: The port on which the server will listen (default: `3000`).
- `DEBUG`: Set to `true` or `false`. Enables/disables development mode features like verbose logging and disables caching for static files. Default is `true`.
- `LOG_LEVEL`: Logging level (e.g., `INFO`, `DEBUG`, `ERROR`). Default: `INFO`.
- `ALLOWED_ORIGINS`: Comma-separated list of allowed CORS origins (e.g., `http://localhost:3000,http://127.0.0.1:3000`). Default: `*` (all origins).
- `HOST`: The host address to bind to (default: `127.0.0.1`).

The application uses SQLite database (`eneopi.db`) by default for user authentication data.
