# ENEOPI Fragment Segmentation Server

A production-ready FastAPI server providing an AI-powered API and web interface for segmenting objects in images and estimating their volumes. Features JWT authentication, OAuth integration, and dual segmentation modes with depth information support.

## 🚀 Features

### 🔐 Authentication & Security
- **JWT-based Authentication** with secure token management and refresh capabilities
- **OAuth Integration** with Google Sign-In support for seamless user experience
- **User Registration & Login** with comprehensive email validation
- **Password Security** using bcrypt hashing with configurable rounds
- **Session Management** with automatic token expiration and refresh
- **Protected Routes** ensuring secure access to all segmentation services

### 🖼️ Dual Segmentation Modes
- **Fast Mode (RGB):** Uses optimized YOLO ONNX models for rapid processing of standard RGB images with 2D-based volume estimation
- **Precise Mode (RGB-D):** Employs advanced YOLO ONNX models leveraging depth information (generated by Depth Anything V2) for enhanced accuracy with 3D point cloud-based volume calculation

### 🌐 Modern Web Interface
- **Responsive Design:** Beautiful, mobile-friendly interface with modern UI/UX patterns
- **Real-time Processing:** Live feedback with progress indicators and result visualization
- **Drag & Drop Upload:** Intuitive file upload with format validation
- **Interactive Results:** Dynamic display of segmented images and volume measurements
- **User Dashboard:** Personal account management and processing history

### 🛠️ Technical Capabilities
- **ONNX Model Inference:** High-performance model execution with CPU optimization
- **Depth Estimation:** Integrated Depth Anything V2 for monocular depth map generation
- **Point Cloud Processing:** Advanced 3D volume calculation using convex hull algorithms
- **Image Processing:** Support for JPEG/PNG formats with OpenCV integration
- **Configuration Management:** Centralized settings via environment variables
- **Comprehensive Logging:** Detailed event tracking and error monitoring
- **Docker Support:** Complete containerization for easy deployment

## 📁 Server Architecture & File Structure

```css
server/
├── app.py                 # Main FastAPI application and lifecycle management
├── model.py              # Core segmentation logic and model handlers
├── config.py             # Configuration management and environment settings
├── requirements.txt      # Python dependencies
├── .env_example         # Environment variables template
├── docker/              # Docker deployment configuration
│   ├── Dockerfile       # Container build instructions
│   ├── docker-compose.yml # Service orchestration
│   └── .dockerignore    # Build optimization rules
├── auth/                # Authentication system
│   ├── routes.py        # Authentication API endpoints
│   ├── models.py        # User database models (SQLAlchemy)
│   ├── schemas.py       # Request/response validation (Pydantic)
│   ├── auth_handler.py  # JWT and password utilities
│   ├── oauth_handler.py # OAuth integration logic
│   ├── database.py      # Database connection and initialization
│   └── dependencies.py  # FastAPI security dependencies
├── frontend/            # Web interface files
│   ├── html/           # Application pages
│   │   ├── index.html  # Main application interface
│   │   ├── login.html  # User authentication page
│   │   ├── signup.html # User registration page
│   │   └── oauth-success.html # OAuth callback handling
│   ├── css/            # Stylesheets
│   └── js/             # Client-side JavaScript
├── utils/              # Utility modules
│   ├── depth_handler.py      # Depth Anything V2 integration
│   ├── pointcloud.py         # 3D point cloud and volume calculation
│   └── depth_anything_v2/    # Depth estimation model source
└── weights/            # Pre-trained model weights (required)
    ├── yolo_rgb_nano.onnx    # RGB segmentation model
    ├── yolo_rgbd_nano.onnx   # RGB-D segmentation model
    └── depth_anything_v2_vits.pth # Depth estimation model
```

### 🔧 Core Components

**`app.py`** - Main FastAPI application
- Defines API endpoints and request handling
- Manages authentication middleware and protected routes
- Integrates model handlers and lifecycle management
- Handles static file serving with development cache control

**`model.py`** - Image analysis engine
- `BaseModelHandler`: Abstract base class for model operations
- `ModelHandler`: RGB YOLO segmentation with 2D volume estimation
- `RGBDModelHandler`: RGB-D YOLO segmentation with 3D depth-enhanced analysis

**`config.py`** - Configuration management
- Environment variable handling with defaults
- Model paths and inference parameters
- OAuth provider settings and security configurations
- Logging and CORS configuration

**`auth/` directory** - Complete authentication system
- JWT token creation, validation, and refresh
- OAuth integration with Google Sign-In
- User registration with email validation
- SQLAlchemy database models and session management
- Pydantic schemas for request/response validation

**`frontend/` directory** - Modern web interface
- Responsive HTML5/CSS3/JavaScript application
- Real-time form validation and error handling
- Interactive file upload and result visualization
- OAuth integration with seamless authentication flow

**`utils/` directory** - Specialized utilities
- Depth estimation pipeline with Depth Anything V2
- Point cloud generation and 3D volume calculation
- Advanced geometric algorithms for precise measurements

## 🚀 Setup & Deployment

### 1. Environment Configuration

Create a `.env` file in the `server` directory:

```bash
cp .env_example .env
```

**Key Environment Variables:**

```bash
# Server Configuration
PORT=3000
HOST=127.0.0.1
DEBUG=true
LOG_LEVEL=INFO

# OAuth Configuration (Optional)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/oauth/google/callback

# Security Settings
ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
```

### 2. Model Weights Setup

**Download Required Models:**
- Source: [EnEoPi Weights Drive](https://drive.google.com/drive/folders/1REDe3jkkYV856jkzJiQ5LFVdSxQ5qXeQ?usp=sharing)

**Place in `server/weights/`:**

```bash
mkdir -p server/weights
```

**Required Files:**
- `yolo_rgb_nano.onnx` - RGB segmentation model
- `yolo_rgbd_nano.onnx` - RGB-D segmentation model  
- `depth_anything_v2_vits.pth` - Depth estimation model

### 3. Docker Deployment (Recommended)

**Prerequisites:**
- Docker and Docker Compose installed
- Model weights in `server/weights/`
- Environment file configured

**Deploy:**

```bash
cd server/docker
docker-compose up -d --build
```

**Access Application:**
- URL: [http://localhost:3000](http://localhost:3000)
- First-time users: Register new account
- Existing users: Sign in with credentials or Google OAuth

### 4. Local Development Setup

**Python Environment:**

```bash
cd server
python -m venv venv

# Windows
venv\Scripts\activate

# macOS/Linux  
source venv/bin/activate

pip install -r requirements.txt
```

**Run Development Server:**

```bash
python app.py
```

**Features in Development Mode:**
- Auto-reload on code changes
- Detailed error logging
- Disabled static file caching
- Extended debug information

## 🔗 API Reference

### Authentication Endpoints

**User Registration**:

```http
POST /auth/register
Content-Type: application/json

{
    "username": "user123",
    "email": "user@example.com", 
    "password": "securepassword",
    "confirm_password": "securepassword"
}
```

**User Login**:

```http
POST /auth/login
Content-Type: application/x-www-form-urlencoded

username=user123&password=securepassword
```

**OAuth Google Login**:

```http
POST /auth/oauth/google
Content-Type: application/json

{
    "credential": "google_jwt_token"
}
```

**Get Current User**:

```http
GET /auth/me
Authorization: Bearer {jwt_token}
```

### Core Functionality

**Web Interface**:

```http
GET /
Authorization: Bearer {jwt_token}
```

Returns the main application HTML interface.

**Image Segmentation**:

```http
POST /predict?use_depth=fast|precise
Authorization: Bearer {jwt_token}
Content-Type: multipart/form-data

file: {image_file}
```

**Response Format:**:

```json
{
    "success": true,
    "image_data": "data:image/png;base64,{base64_image}",
    "volumes": [2.34, 1.87, 3.21],
    "process_time_ms": 1250
}
```

**Parameters:**
- `use_depth`: Processing mode
  - `"fast"` (default): RGB-only processing for speed
  - `"precise"`: RGB-D processing with depth enhancement
- `file`: Image file (JPEG/PNG, max size as configured)

## 🔧 Configuration Options

### Model Parameters

```python
# Inference thresholds
YOLO_CONF_THRESHOLD = 0.25    # Confidence threshold
YOLO_IOU_THRESHOLD = 0.7      # IoU threshold for NMS
YOLO_RETINA_MASKS = True      # High-resolution mask output

# Image dimensions
MODEL_INPUT_WIDTH = 512       # Model input width
MODEL_INPUT_HEIGHT = 512      # Model input height
```

### Depth Model Configuration

```python
# Available depth model variants
DEPTH_MODEL_TYPE = 'vits'     # Options: vits, vitb, vitl, vitg
```

### Point Cloud Settings

```python
# Camera parameters for 3D reconstruction
FOCAL_LENGTH_X = 470.4        # Camera focal length X
FOCAL_LENGTH_Y = 470.4        # Camera focal length Y
MAX_DEPTH = 20.0             # Maximum depth normalization
```

### Development Mode Features

**No-Cache Static Files:** Development mode disables caching for immediate updates to frontend files.

**Enhanced Logging:** Detailed request/response logging and error tracebacks.

**Hot Reload:** Automatic server restart on code changes.

## 📊 Monitoring & Logging

The server provides comprehensive logging to both console and file (`api.log`):

- **Authentication Events:** Login attempts, registrations, token operations
- **Processing Metrics:** Model inference times, file processing statistics
- **Error Tracking:** Detailed error logs with stack traces
- **Request Logging:** API endpoint usage and response times
